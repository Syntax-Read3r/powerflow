name: PowerFlow Release

on:
  push:
    tags:
      - 'v*'  # ‚úÖ FIX: Triggers on ANY version tag like v1.0.1, v1.0.2, v2.0.0, etc.

env:
  REPO_NAME: powerflow
  PROFILE_FILE: Microsoft.PowerShell_profile.ps1
  UBUNTU_BASHRC_FILE: ubuntu/.bashrc
  UBUNTU_INSTALL_FILE: ubuntu/install.sh
  UBUNTU_UNINSTALL_FILE: ubuntu/uninstall.sh

jobs:
  validate:
    name: üîç Validate Release
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üè∑Ô∏è Get Version from Tag
        id: get_version
        run: |
          $tagName = "${{ github.ref_name }}"
          $version = $tagName -replace '^v', ''
          Write-Output "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Output "tag_name=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "üè∑Ô∏è Tag: $tagName"
          Write-Host "üì¶ Version: $version"
        shell: pwsh
        
      - name: ‚úÖ Validate Profile Files Exist
        run: |
          # Check PowerShell profile
          if (-not (Test-Path "${{ env.PROFILE_FILE }}")) {
            Write-Error "‚ùå PowerShell profile file not found: ${{ env.PROFILE_FILE }}"
            exit 1
          }
          Write-Host "‚úÖ PowerShell profile file found: ${{ env.PROFILE_FILE }}"
          
          # Check Ubuntu .bashrc
          if (-not (Test-Path "${{ env.UBUNTU_BASHRC_FILE }}")) {
            Write-Error "‚ùå Ubuntu .bashrc file not found: ${{ env.UBUNTU_BASHRC_FILE }}"
            exit 1
          }
          Write-Host "‚úÖ Ubuntu .bashrc file found: ${{ env.UBUNTU_BASHRC_FILE }}"
          
          # Check Ubuntu install script
          if (-not (Test-Path "${{ env.UBUNTU_INSTALL_FILE }}")) {
            Write-Warning "‚ö†Ô∏è Ubuntu install script not found: ${{ env.UBUNTU_INSTALL_FILE }}"
          } else {
            Write-Host "‚úÖ Ubuntu install script found: ${{ env.UBUNTU_INSTALL_FILE }}"
          }
          
          # Check Ubuntu uninstall script
          if (-not (Test-Path "${{ env.UBUNTU_UNINSTALL_FILE }}")) {
            Write-Warning "‚ö†Ô∏è Ubuntu uninstall script not found: ${{ env.UBUNTU_UNINSTALL_FILE }}"
          } else {
            Write-Host "‚úÖ Ubuntu uninstall script found: ${{ env.UBUNTU_UNINSTALL_FILE }}"
          }
        shell: pwsh
        
      - name: üîç Validate Version in Profiles
        run: |
          $expectedVersion = "${{ steps.get_version.outputs.version }}"
          
          # Validate PowerShell profile version
          $profileContent = Get-Content "${{ env.PROFILE_FILE }}" -Raw
          if ($profileContent -notmatch '\$script:POWERFLOW_VERSION = "([^"]+)"') {
            Write-Error "‚ùå POWERFLOW_VERSION not found in PowerShell profile"
            exit 1
          }
          
          $profileVersion = $matches[1]
          Write-Host "üì¶ PowerShell profile version: $profileVersion"
          Write-Host "üè∑Ô∏è Tag version: $expectedVersion"
          
          if ($profileVersion -ne $expectedVersion) {
            Write-Error "‚ùå PowerShell version mismatch! Profile: $profileVersion, Tag: $expectedVersion"
            Write-Host "üí° Update POWERFLOW_VERSION in PowerShell profile to match tag"
            exit 1
          }
          
          # Validate Ubuntu .bashrc version
          $bashrcContent = Get-Content "${{ env.UBUNTU_BASHRC_FILE }}" -Raw
          if ($bashrcContent -notmatch 'WSL_PROFILE_VERSION="([^"]+)"') {
            Write-Warning "‚ö†Ô∏è WSL_PROFILE_VERSION not found in Ubuntu .bashrc"
          } else {
            $bashrcVersion = $matches[1]
            Write-Host "üêß Ubuntu .bashrc version: $bashrcVersion"
            
            if ($bashrcVersion -ne $expectedVersion) {
              Write-Warning "‚ö†Ô∏è Ubuntu version mismatch! .bashrc: $bashrcVersion, Tag: $expectedVersion"
              Write-Host "üí° Consider updating WSL_PROFILE_VERSION in .bashrc to match tag"
            }
          }
          
          Write-Host "‚úÖ Version validation completed"
        shell: pwsh
        
      - name: üß™ Test Profile Syntax
        run: |
          try {
            # Test PowerShell syntax without executing
            $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content "${{ env.PROFILE_FILE }}" -Raw), [ref]$null)
            Write-Host "‚úÖ Profile syntax validation passed"
          } catch {
            Write-Error "‚ùå Profile syntax error: $($_.Exception.Message)"
            exit 1
          }
        shell: pwsh

  create-release-files:
    name: üì¶ Create Release Files
    runs-on: windows-latest
    needs: validate
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üìù Generate Install Scripts
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          $tagName = "${{ needs.validate.outputs.tag_name }}"
          
          # Generate PowerShell install script
          $installScript = @"
          #Requires -Version 5.1
          
          <#
          .SYNOPSIS
              PowerFlow Installation Script v$version
          .DESCRIPTION
              Installs PowerFlow PowerShell profile with all dependencies
          .PARAMETER Force
              Overwrite existing profile without confirmation
          .EXAMPLE
              .\install.ps1
              .\install.ps1 -Force
          #>
          
          param([switch]`$Force)
          
          `$ErrorActionPreference = "Stop"
          
          Write-Host "üöÄ PowerFlow v$version Installation" -ForegroundColor Cyan
          Write-Host "=================================================" -ForegroundColor Cyan
          
          # Check PowerShell version
          if (`$PSVersionTable.PSVersion.Major -lt 5) {
              Write-Host "‚ùå PowerShell 5.1 or higher required" -ForegroundColor Red
              Write-Host "üí° Download PowerShell 7: https://aka.ms/powershell" -ForegroundColor Yellow
              exit 1
          }
          
          # Get profile path
          `$profilePath = `$PROFILE
          `$profileDir = Split-Path `$profilePath -Parent
          
          Write-Host "üìÅ Profile location: `$profilePath" -ForegroundColor White
          
          # Check if profile exists
          if ((Test-Path `$profilePath) -and -not `$Force) {
              Write-Host "‚ö†Ô∏è  PowerShell profile already exists!" -ForegroundColor Yellow
              `$choice = Read-Host "Overwrite existing profile? (y/n)"
              if (`$choice -ne 'y') {
                  Write-Host "‚ùå Installation cancelled" -ForegroundColor Red
                  exit 1
              }
              
              # Create backup
              `$backupPath = "`$profilePath.backup.`$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item `$profilePath `$backupPath
              Write-Host "üíæ Backup created: `$backupPath" -ForegroundColor Cyan
          }
          
          # Create profile directory if needed
          if (-not (Test-Path `$profileDir)) {
              Write-Host "üìÇ Creating profile directory..." -ForegroundColor Yellow
              New-Item -ItemType Directory -Path `$profileDir -Force | Out-Null
          }
          
          # Download latest profile
          try {
              Write-Host "‚¨áÔ∏è  Downloading PowerFlow profile..." -ForegroundColor Yellow
              `$downloadUrl = "https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/Microsoft.PowerShell_profile.ps1"
              
              # Try release asset first, fallback to raw GitHub
              try {
                  Invoke-RestMethod -Uri `$downloadUrl -OutFile `$profilePath -ErrorAction Stop
              } catch {
                  Write-Host "   üì° Trying alternative download..." -ForegroundColor DarkGray
                  `$fallbackUrl = "https://raw.githubusercontent.com/Syntax-Read3r/powerflow/$tagName/Microsoft.PowerShell_profile.ps1"
                  Invoke-RestMethod -Uri `$fallbackUrl -OutFile `$profilePath -ErrorAction Stop
              }
              
              Write-Host "‚úÖ Profile downloaded successfully" -ForegroundColor Green
          } catch {
              Write-Host "‚ùå Failed to download profile: `$(`$_.Exception.Message)" -ForegroundColor Red
              Write-Host "üí° Manual download: https://github.com/Syntax-Read3r/powerflow/releases" -ForegroundColor Yellow
              exit 1
          }
          
          Write-Host ""
          Write-Host "üéâ PowerFlow v$version installed successfully!" -ForegroundColor Green
          Write-Host "üîÑ Restart PowerShell or run: . ```$PROFILE" -ForegroundColor Cyan
          Write-Host "üí° Type 'pwsh-h' for help after restart" -ForegroundColor Yellow
          Write-Host "üåü Repository: https://github.com/Syntax-Read3r/powerflow" -ForegroundColor DarkGray
          "@
          
          Set-Content "install.ps1" $installScript -Encoding UTF8
          Write-Host "‚úÖ Generated install.ps1"
          
          # Generate Ubuntu install script
          $ubuntuInstallScript = @"
          #!/bin/bash
          
          # PowerFlow Ubuntu Installation Script v$version
          # Enhanced bash profile for Ubuntu/WSL environments
          
          set -e
          
          echo "üöÄ PowerFlow v$version Ubuntu Installation"
          echo "=============================================="
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          CYAN='\033[0;36m'
          NC='\033[0m' # No Color
          
          # Check if running on Ubuntu/Debian
          if ! command -v apt >/dev/null 2>&1; then
              echo -e "`${RED}‚ùå This script is designed for Ubuntu/Debian systems with apt package manager`${NC}"
              exit 1
          fi
          
          # Backup existing .bashrc
          if [ -f "`$HOME/.bashrc" ]; then
              backup_file="`$HOME/.bashrc.backup.`$(date +%Y%m%d_%H%M%S)"
              echo -e "`${YELLOW}üíæ Backing up existing .bashrc to: `$backup_file`${NC}"
              cp "`$HOME/.bashrc" "`$backup_file"
          fi
          
          # Download PowerFlow .bashrc
          echo -e "`${YELLOW}‚¨áÔ∏è  Downloading PowerFlow .bashrc...`${NC}"
          
          if command -v curl >/dev/null 2>&1; then
              download_url="https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/.bashrc"
              if ! curl -fsSL "`$download_url" -o "`$HOME/.bashrc" 2>/dev/null; then
                  echo -e "`${CYAN}   üì° Trying alternative download...`${NC}"
                  fallback_url="https://raw.githubusercontent.com/Syntax-Read3r/powerflow/$tagName/ubuntu/.bashrc"
                  curl -fsSL "`$fallback_url" -o "`$HOME/.bashrc"
              fi
          elif command -v wget >/dev/null 2>&1; then
              download_url="https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/.bashrc"
              if ! wget -q "`$download_url" -O "`$HOME/.bashrc" 2>/dev/null; then
                  echo -e "`${CYAN}   üì° Trying alternative download...`${NC}"
                  fallback_url="https://raw.githubusercontent.com/Syntax-Read3r/powerflow/$tagName/ubuntu/.bashrc"
                  wget -q "`$fallback_url" -O "`$HOME/.bashrc"
              fi
          else
              echo -e "`${RED}‚ùå Neither curl nor wget found. Please install one of them first.`${NC}"
              exit 1
          fi
          
          echo -e "`${GREEN}‚úÖ PowerFlow .bashrc downloaded successfully`${NC}"
          echo ""
          echo -e "`${GREEN}üéâ PowerFlow v$version for Ubuntu installed successfully!`${NC}"
          echo -e "`${CYAN}üîÑ Restart your terminal or run: source ~/.bashrc`${NC}"
          echo -e "`${YELLOW}üí° Type 'wsl_help' for help after restart`${NC}"
          echo -e "`${CYAN}üåü Repository: https://github.com/Syntax-Read3r/powerflow`${NC}"
          echo ""
          echo -e "`${YELLOW}üì¶ Note: Dependencies will be automatically installed on first use`${NC}"
          "@
          
          Set-Content "ubuntu-install.sh" $ubuntuInstallScript -Encoding UTF8
          Write-Host "‚úÖ Generated ubuntu-install.sh"
          
          # Generate Ubuntu uninstall script
          $ubuntuUninstallScript = @"
          #!/bin/bash
          
          # PowerFlow Ubuntu Uninstallation Script v$version
          # Removes PowerFlow enhanced bash profile and optionally cleans up dependencies
          
          set -e
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          CYAN='\033[0;36m'
          NC='\033[0m' # No Color
          
          echo -e "`${CYAN}üóëÔ∏è  PowerFlow v$version Ubuntu Uninstall`${NC}"
          echo -e "`${CYAN}=========================================`${NC}"
          
          # Check if .bashrc exists
          if [ ! -f "`$HOME/.bashrc" ]; then
              echo -e "`${YELLOW}‚ÑπÔ∏è  No .bashrc file found`${NC}"
              exit 0
          fi
          
          # Check if it's PowerFlow .bashrc
          if ! grep -q "PowerFlow\|WSL.*Profile" "`$HOME/.bashrc" 2>/dev/null; then
              echo -e "`${YELLOW}‚ÑπÔ∏è  .bashrc doesn't appear to be PowerFlow enhanced`${NC}"
              read -p "Remove anyway? (y/n): " continue_anyway
              if [[ "`$continue_anyway" != "y" ]]; then
                  echo -e "`${RED}‚ùå Uninstall cancelled`${NC}"
                  exit 0
              fi
          fi
          
          # Create backup
          backup_file="`$HOME/.bashrc.backup.`$(date +%Y%m%d_%H%M%S)"
          echo -e "`${YELLOW}üíæ Creating backup: `$backup_file`${NC}"
          cp "`$HOME/.bashrc" "`$backup_file"
          
          # Remove .bashrc
          rm -f "`$HOME/.bashrc"
          echo -e "`${GREEN}‚úÖ PowerFlow .bashrc removed`${NC}"
          
          # Clean up PowerFlow files
          echo -e "`${YELLOW}üßπ Cleaning up PowerFlow files...`${NC}"
          rm -f "`$HOME/.wsl_bookmarks.json"
          rm -f "`$HOME/.wsl_init_check"
          rm -f "`$HOME/.wsl_profile_update_check"
          rm -f "`$HOME/.nav_history"
          rm -f /tmp/.powerflow_* 2>/dev/null
          
          echo -e "`${GREEN}‚úÖ PowerFlow uninstall completed!`${NC}"
          echo -e "`${CYAN}üíæ Backup saved to: `$backup_file`${NC}"
          echo -e "`${YELLOW}üîÑ Restart your terminal or run: source ~/.bashrc`${NC}"
          echo -e "`${CYAN}üôè Thanks for trying PowerFlow!`${NC}"
          "@
          
          Set-Content "ubuntu-uninstall.sh" $ubuntuUninstallScript -Encoding UTF8
          Write-Host "‚úÖ Generated ubuntu-uninstall.sh"
        shell: pwsh
        
      - name: üìù Generate Uninstall Script
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          
          $uninstallScript = @"
          <#
          .SYNOPSIS
              PowerFlow Uninstallation Script v$version
          .DESCRIPTION
              Removes PowerFlow profile and optionally cleans up dependencies
          #>
          
          Write-Host "üóëÔ∏è  PowerFlow v$version Uninstall" -ForegroundColor Yellow
          Write-Host "=============================================" -ForegroundColor Yellow
          
          `$profilePath = `$PROFILE
          
          if (-not (Test-Path `$profilePath)) {
              Write-Host "‚ÑπÔ∏è  No PowerShell profile found at: `$profilePath" -ForegroundColor Yellow
              exit 0
          }
          
          # Check if it's PowerFlow profile
          `$content = Get-Content `$profilePath -Raw -ErrorAction SilentlyContinue
          if (`$content -and `$content -notmatch "PowerFlow") {
              Write-Host "‚ÑπÔ∏è  Profile doesn't appear to be PowerFlow" -ForegroundColor Yellow
              `$continue = Read-Host "Remove anyway? (y/n)"
              if (`$continue -ne 'y') {
                  Write-Host "‚ùå Uninstall cancelled" -ForegroundColor Yellow
                  exit 0
              }
          }
          
          # Backup before removal
          `$backupPath = "`$profilePath.backup.`$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          Write-Host "üíæ Creating backup: `$backupPath" -ForegroundColor Cyan
          Copy-Item `$profilePath `$backupPath -ErrorAction SilentlyContinue
          
          # Remove profile
          Remove-Item `$profilePath -Force
          Write-Host "‚úÖ PowerFlow profile removed" -ForegroundColor Green
          Write-Host "üíæ Backup saved to: `$backupPath" -ForegroundColor Cyan
          
          # Ask about dependencies
          Write-Host "`nüîß Remove installed dependencies?" -ForegroundColor Yellow
          Write-Host "   ‚Ä¢ Starship prompt" -ForegroundColor DarkGray
          Write-Host "   ‚Ä¢ fzf, zoxide, lsd" -ForegroundColor DarkGray
          Write-Host "   ‚Ä¢ FiraCode Nerd Font" -ForegroundColor DarkGray
          
          `$removeDeps = Read-Host "Remove dependencies via Scoop? (y/n)"
          if (`$removeDeps -eq 'y') {
              if (Get-Command scoop -ErrorAction SilentlyContinue) {
                  Write-Host "üßπ Removing Scoop packages..." -ForegroundColor Yellow
                  scoop uninstall starship fzf zoxide lsd FiraCode-NF 2>`$null
                  Write-Host "‚úÖ Dependencies removed" -ForegroundColor Green
              } else {
                  Write-Host "‚ö†Ô∏è  Scoop not found - manual dependency removal required" -ForegroundColor Yellow
              }
          }
          
          Write-Host "`n‚úÖ PowerFlow uninstall complete" -ForegroundColor Green
          Write-Host "üôè Thanks for trying PowerFlow!" -ForegroundColor Cyan
          "@
          
          Set-Content "uninstall.ps1" $uninstallScript -Encoding UTF8
          Write-Host "‚úÖ Generated uninstall.ps1"
        shell: pwsh
        
      - name: üìù Generate Release Notes
        id: release_notes
        run: |
          $tagName = "${{ needs.validate.outputs.tag_name }}"
          $version = "${{ needs.validate.outputs.version }}"
          
          # Try to extract release notes from CHANGELOG.md
          $releaseNotes = ""
          if (Test-Path "CHANGELOG.md") {
              $changelog = Get-Content "CHANGELOG.md" -Raw
              
              # Extract content between current version and next version/unreleased
              $pattern = "(?s)## \[$version\].*?(?=## \[|\z)"
              if ($changelog -match $pattern) {
                  $releaseNotes = $matches[0] -replace "## \[$version\][^\r\n]*[\r\n]*", ""
                  $releaseNotes = $releaseNotes.Trim()
              }
          }
          
          # Fallback release notes
          if (-not $releaseNotes) {
              $releaseNotes = @"
          ## PowerFlow $version
          
          üöÄ Enhanced terminal profile with beautiful interfaces and productivity tools for both Windows and Ubuntu.
          
          ### üéØ Key Features
          - Smart navigation with bookmarks and fuzzy search
          - Enhanced Git workflows with beautiful interfaces
          - Auto-installation of dependencies (Starship, fzf, zoxide, lsd)
          - Cross-platform support (PowerShell & Bash)
          - FiraCode Nerd Font integration
          - GitHub repository integration
          - Comprehensive help system and auto-updates
          
          ### üì¶ Installation
          
          **Windows (PowerShell):**
          ``````powershell
          # Quick install
          irm https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/install.ps1 | iex
          
          # Or download and run
          Invoke-RestMethod -Uri "https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/install.ps1" -OutFile "install.ps1"
          .\install.ps1
          ``````
          
          **Ubuntu/WSL (Bash):**
          ``````bash
          # Quick install
          curl -fsSL https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/ubuntu-install.sh | bash
          
          # Or download and run
          wget https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/ubuntu-install.sh
          chmod +x ubuntu-install.sh
          ./ubuntu-install.sh
          
          # Uninstall
          curl -fsSL https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/ubuntu-uninstall.sh | bash
          ``````
          
          ### üìö Documentation
          - [Installation Guide](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/installation.md)
          - [Ubuntu Documentation](https://github.com/Syntax-Read3r/powerflow/blob/main/ubuntu/README.md)
          - [Troubleshooting](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/troubleshooting.md)
          - [Features Guide](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/features.md)
          
          ---
          
          **üéâ New to PowerFlow?** 
          - Windows: Type ``pwsh-h`` after installation for help
          - Ubuntu: Type ``wsl_help`` after installation for help
          "@
          }
          
          # Save release notes to file
          Set-Content "RELEASE_NOTES.md" $releaseNotes -Encoding UTF8
          Write-Host "‚úÖ Generated release notes"
        shell: pwsh
        
      - name: üì§ Upload Artifacts
        uses: actions/upload-artifact@v4  # ‚úÖ FIX: Updated to v4
        with:
          name: release-files
          path: |
            ${{ env.PROFILE_FILE }}
            ${{ env.UBUNTU_BASHRC_FILE }}
            install.ps1
            ubuntu-install.sh
            uninstall.ps1
            ubuntu-uninstall.sh
            RELEASE_NOTES.md

  create-github-release:
    name: üöÄ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, create-release-files]
    permissions:
      contents: write
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üì• Download Release Files
        uses: actions/download-artifact@v4  # ‚úÖ FIX: Updated to v4
        with:
          name: release-files
          path: ./release-files
          
      # ‚úÖ FIX: Modern release action instead of deprecated ones
      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          name: "PowerFlow ${{ needs.validate.outputs.tag_name }}"
          body_path: ./release-files/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            ./release-files/${{ env.PROFILE_FILE }}
            ./release-files/.bashrc
            ./release-files/install.ps1
            ./release-files/ubuntu-install.sh
            ./release-files/uninstall.ps1
            ./release-files/ubuntu-uninstall.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: üì¢ Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, create-github-release]
    if: success()
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        
      - name: üéâ Release Success Notification
        run: |
          echo "üéâ PowerFlow ${{ needs.validate.outputs.tag_name }} released successfully!"
          echo "üì¶ Release URL: https://github.com/Syntax-Read3r/powerflow/releases/tag/${{ needs.validate.outputs.tag_name }}"
          echo "üì• Install command: irm https://github.com/Syntax-Read3r/powerflow/releases/download/${{ needs.validate.outputs.tag_name }}/install.ps1 | iex"