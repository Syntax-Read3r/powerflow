name: PowerFlow Release

on:
  push:
    tags:
      - 'v1.0.1'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

env:
  REPO_NAME: powerflow
  PROFILE_FILE: Microsoft.PowerShell_profile.ps1

jobs:
  validate:
    name: ğŸ” Validate Release
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Get Version from Tag
        id: get_version
        run: |
          $tagName = "${{ github.ref_name }}"
          $version = $tagName -replace '^v', ''
          Write-Output "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Output "tag_name=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "ğŸ·ï¸ Tag: $tagName"
          Write-Host "ğŸ“¦ Version: $version"
        shell: pwsh
        
      - name: âœ… Validate Profile File Exists
        run: |
          if (-not (Test-Path "${{ env.PROFILE_FILE }}")) {
            Write-Error "âŒ Profile file not found: ${{ env.PROFILE_FILE }}"
            exit 1
          }
          Write-Host "âœ… Profile file found: ${{ env.PROFILE_FILE }}"
        shell: pwsh
        
      - name: ğŸ” Validate Version in Profile
        run: |
          $profileContent = Get-Content "${{ env.PROFILE_FILE }}" -Raw
          $expectedVersion = "${{ steps.get_version.outputs.version }}"
          
          # Check if version is defined in profile
          if ($profileContent -notmatch '\$script:POWERFLOW_VERSION = "([^"]+)"') {
            Write-Error "âŒ POWERFLOW_VERSION not found in profile"
            exit 1
          }
          
          $profileVersion = $matches[1]
          Write-Host "ğŸ“¦ Profile version: $profileVersion"
          Write-Host "ğŸ·ï¸ Tag version: $expectedVersion"
          
          if ($profileVersion -ne $expectedVersion) {
            Write-Error "âŒ Version mismatch! Profile: $profileVersion, Tag: $expectedVersion"
            Write-Host "ğŸ’¡ Update POWERFLOW_VERSION in profile to match tag"
            exit 1
          }
          
          Write-Host "âœ… Version validation passed"
        shell: pwsh
        
      - name: ğŸ§ª Test Profile Syntax
        run: |
          try {
            # Test PowerShell syntax without executing
            $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content "${{ env.PROFILE_FILE }}" -Raw), [ref]$null)
            Write-Host "âœ… Profile syntax validation passed"
          } catch {
            Write-Error "âŒ Profile syntax error: $($_.Exception.Message)"
            exit 1
          }
        shell: pwsh

  create-release-files:
    name: ğŸ“¦ Create Release Files
    runs-on: windows-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“ Generate Install Script
        run: |
          $installScript = @'
          #Requires -Version 5.1
          
          <#
          .SYNOPSIS
              PowerFlow Installation Script v${{ needs.validate.outputs.version }}
          .DESCRIPTION
              Installs PowerFlow PowerShell profile with all dependencies
          .PARAMETER Force
              Overwrite existing profile without confirmation
          .EXAMPLE
              .\install.ps1
              .\install.ps1 -Force
          #>
          
          param([switch]$Force)
          
          $ErrorActionPreference = "Stop"
          
          Write-Host "ğŸš€ PowerFlow v${{ needs.validate.outputs.version }} Installation" -ForegroundColor Cyan
          Write-Host "=================================================" -ForegroundColor Cyan
          
          # Check PowerShell version
          if ($PSVersionTable.PSVersion.Major -lt 5) {
              Write-Host "âŒ PowerShell 5.1 or higher required" -ForegroundColor Red
              Write-Host "ğŸ’¡ Download PowerShell 7: https://aka.ms/powershell" -ForegroundColor Yellow
              exit 1
          }
          
          # Get profile path
          $profilePath = $PROFILE
          $profileDir = Split-Path $profilePath -Parent
          
          Write-Host "ğŸ“ Profile location: $profilePath" -ForegroundColor White
          
          # Check if profile exists
          if ((Test-Path $profilePath) -and -not $Force) {
              Write-Host "âš ï¸  PowerShell profile already exists!" -ForegroundColor Yellow
              $choice = Read-Host "Overwrite existing profile? (y/n)"
              if ($choice -ne 'y') {
                  Write-Host "âŒ Installation cancelled" -ForegroundColor Red
                  exit 1
              }
              
              # Create backup
              $backupPath = "$profilePath.backup.$(Get-Date -Format 'yyyyMMdd-HHmmss')"
              Copy-Item $profilePath $backupPath
              Write-Host "ğŸ’¾ Backup created: $backupPath" -ForegroundColor Cyan
          }
          
          # Create profile directory if needed
          if (-not (Test-Path $profileDir)) {
              Write-Host "ğŸ“‚ Creating profile directory..." -ForegroundColor Yellow
              New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
          }
          
          # Download latest profile
          try {
              Write-Host "â¬‡ï¸  Downloading PowerFlow profile..." -ForegroundColor Yellow
              $downloadUrl = "https://github.com/Syntax-Read3r/powerflow/releases/download/${{ needs.validate.outputs.tag_name }}/Microsoft.PowerShell_profile.ps1"
              
              # Try release asset first, fallback to raw GitHub
              try {
                  Invoke-RestMethod -Uri $downloadUrl -OutFile $profilePath -ErrorAction Stop
              } catch {
                  Write-Host "   ğŸ“¡ Trying alternative download..." -ForegroundColor DarkGray
                  $fallbackUrl = "https://raw.githubusercontent.com/Syntax-Read3r/powerflow/${{ needs.validate.outputs.tag_name }}/Microsoft.PowerShell_profile.ps1"
                  Invoke-RestMethod -Uri $fallbackUrl -OutFile $profilePath -ErrorAction Stop
              }
              
              Write-Host "âœ… Profile downloaded successfully" -ForegroundColor Green
          } catch {
              Write-Host "âŒ Failed to download profile: $($_.Exception.Message)" -ForegroundColor Red
              Write-Host "ğŸ’¡ Manual download: https://github.com/Syntax-Read3r/powerflow/releases" -ForegroundColor Yellow
              exit 1
          }
          
          Write-Host ""
          Write-Host "ğŸ‰ PowerFlow v${{ needs.validate.outputs.version }} installed successfully!" -ForegroundColor Green
          Write-Host "ğŸ”„ Restart PowerShell or run: . `$PROFILE" -ForegroundColor Cyan
          Write-Host "ğŸ’¡ Type 'pwsh-h' for help after restart" -ForegroundColor Yellow
          Write-Host "ğŸŒŸ Repository: https://github.com/Syntax-Read3r/powerflow" -ForegroundColor DarkGray
          '@
          
          Set-Content "install.ps1" $installScript -Encoding UTF8
          Write-Host "âœ… Generated install.ps1"
        shell: pwsh
        
      - name: ğŸ“ Generate Uninstall Script
        run: |
          $uninstallScript = @'
          <#
          .SYNOPSIS
              PowerFlow Uninstallation Script v${{ needs.validate.outputs.version }}
          .DESCRIPTION
              Removes PowerFlow profile and optionally cleans up dependencies
          #>
          
          Write-Host "ğŸ—‘ï¸  PowerFlow v${{ needs.validate.outputs.version }} Uninstall" -ForegroundColor Yellow
          Write-Host "=============================================" -ForegroundColor Yellow
          
          $profilePath = $PROFILE
          
          if (-not (Test-Path $profilePath)) {
              Write-Host "â„¹ï¸  No PowerShell profile found at: $profilePath" -ForegroundColor Yellow
              exit 0
          }
          
          # Check if it's PowerFlow profile
          $content = Get-Content $profilePath -Raw -ErrorAction SilentlyContinue
          if ($content -and $content -notmatch "PowerFlow") {
              Write-Host "â„¹ï¸  Profile doesn't appear to be PowerFlow" -ForegroundColor Yellow
              $continue = Read-Host "Remove anyway? (y/n)"
              if ($continue -ne 'y') {
                  Write-Host "âŒ Uninstall cancelled" -ForegroundColor Yellow
                  exit 0
              }
          }
          
          # Backup before removal
          $backupPath = "$profilePath.backup.$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          Write-Host "ğŸ’¾ Creating backup: $backupPath" -ForegroundColor Cyan
          Copy-Item $profilePath $backupPath -ErrorAction SilentlyContinue
          
          # Remove profile
          Remove-Item $profilePath -Force
          Write-Host "âœ… PowerFlow profile removed" -ForegroundColor Green
          Write-Host "ğŸ’¾ Backup saved to: $backupPath" -ForegroundColor Cyan
          
          # Ask about dependencies
          Write-Host "`nğŸ”§ Remove installed dependencies?" -ForegroundColor Yellow
          Write-Host "   â€¢ Starship prompt" -ForegroundColor DarkGray
          Write-Host "   â€¢ fzf, zoxide, lsd" -ForegroundColor DarkGray
          Write-Host "   â€¢ FiraCode Nerd Font" -ForegroundColor DarkGray
          
          $removeDeps = Read-Host "Remove dependencies via Scoop? (y/n)"
          if ($removeDeps -eq 'y') {
              if (Get-Command scoop -ErrorAction SilentlyContinue) {
                  Write-Host "ğŸ§¹ Removing Scoop packages..." -ForegroundColor Yellow
                  scoop uninstall starship fzf zoxide lsd FiraCode-NF 2>$null
                  Write-Host "âœ… Dependencies removed" -ForegroundColor Green
              } else {
                  Write-Host "âš ï¸  Scoop not found - manual dependency removal required" -ForegroundColor Yellow
              }
          }
          
          Write-Host "`nâœ… PowerFlow uninstall complete" -ForegroundColor Green
          Write-Host "ğŸ™ Thanks for trying PowerFlow!" -ForegroundColor Cyan
          '@
          
          Set-Content "uninstall.ps1" $uninstallScript -Encoding UTF8
          Write-Host "âœ… Generated uninstall.ps1"
        shell: pwsh
        
      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          $tagName = "${{ needs.validate.outputs.tag_name }}"
          $version = "${{ needs.validate.outputs.version }}"
          
          # Try to extract release notes from CHANGELOG.md
          $releaseNotes = ""
          if (Test-Path "CHANGELOG.md") {
              $changelog = Get-Content "CHANGELOG.md" -Raw
              
              # Extract content between current version and next version/unreleased
              $pattern = "(?s)## \[$version\].*?(?=## \[|\z)"
              if ($changelog -match $pattern) {
                  $releaseNotes = $matches[0] -replace "## \[$version\][^\r\n]*[\r\n]*", ""
                  $releaseNotes = $releaseNotes.Trim()
              }
          }
          
          # Fallback release notes
          if (-not $releaseNotes) {
              $releaseNotes = @"
          ## PowerFlow $version
          
          ğŸš€ Enhanced PowerShell profile with beautiful interfaces and productivity tools.
          
          ### ğŸ¯ Key Features
          - Smart navigation with bookmarks and fuzzy search
          - Enhanced Git workflows with beautiful interfaces
          - Auto-installation of dependencies (Starship, fzf, zoxide, lsd)
          - FiraCode Nerd Font integration
          - GitHub repository integration
          - Comprehensive help system and auto-updates
          
          ### ğŸ“¦ Installation
          ``````powershell
          # Quick install
          irm https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/install.ps1 | iex
          
          # Or download and run
          Invoke-RestMethod -Uri "https://github.com/Syntax-Read3r/powerflow/releases/download/$tagName/install.ps1" -OutFile "install.ps1"
          .\install.ps1
          ``````
          
          ### ğŸ“š Documentation
          - [Installation Guide](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/installation.md)
          - [Troubleshooting](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/troubleshooting.md)
          - [Features Guide](https://github.com/Syntax-Read3r/powerflow/blob/main/docs/features.md)
          
          ---
          
          **ğŸ‰ New to PowerFlow?** Type ``pwsh-h`` after installation for help!
          "@
          }
          
          # Save release notes to file
          Set-Content "RELEASE_NOTES.md" $releaseNotes -Encoding UTF8
          
          # Output for GitHub Actions (handle multiline)
          $releaseNotesEscaped = $releaseNotes -replace '%', '%25' -replace '\r', '%0D' -replace '\n', '%0A'
          Write-Output "notes=$releaseNotesEscaped" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          Write-Host "âœ… Generated release notes"
        shell: pwsh
        
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-files
          path: |
            ${{ env.PROFILE_FILE }}
            install.ps1
            uninstall.ps1
            RELEASE_NOTES.md

  create-github-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, create-release-files]
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download Release Files
        uses: actions/download-artifact@v3
        with:
          name: release-files
          path: ./release-files
          
      - name: ğŸš€ Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          release_name: "PowerFlow ${{ needs.validate.outputs.tag_name }}"
          body_path: ./release-files/RELEASE_NOTES.md
          draft: false
          prerelease: false
          
      - name: ğŸ“ Upload Profile File
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-files/${{ env.PROFILE_FILE }}
          asset_name: ${{ env.PROFILE_FILE }}
          asset_content_type: text/plain
          
      - name: ğŸ“ Upload Install Script
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-files/install.ps1
          asset_name: install.ps1
          asset_content_type: text/plain
          
      - name: ğŸ“ Upload Uninstall Script
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-files/uninstall.ps1
          asset_name: uninstall.ps1
          asset_content_type: text/plain

  post-release:
    name: ğŸ“¢ Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, create-github-release]
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ‰ Release Success Notification
        run: |
          echo "ğŸ‰ PowerFlow ${{ needs.validate.outputs.tag_name }} released successfully!"
          echo "ğŸ“¦ Release URL: https://github.com/Syntax-Read3r/powerflow/releases/tag/${{ needs.validate.outputs.tag_name }}"
          echo "ğŸ“¥ Install command: irm https://github.com/Syntax-Read3r/powerflow/releases/download/${{ needs.validate.outputs.tag_name }}/install.ps1 | iex"
          
      # Optional: Could add Discord/Slack notifications, update documentation, etc.
      # - name: ğŸ“¢ Notify Discord/Slack
      #   run: |
      #     # Add webhook notifications here
      
      # - name: ğŸ“ Update Documentation
      #   run: |
      #     # Auto-update documentation with new version